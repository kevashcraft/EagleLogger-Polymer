<dom-module id="elp-net">
<style>
	:host {
		display: block;
	}
	paper-dialog paper-button {
		display: block;
	}
	paper-fab {
		position: fixed;
		bottom: 25px;
		right: 25px;
	}
	.checkins{
		padding-bottom: 45px;
	}
	.bottom {
		position: fixed;
		bottom: 5px;
	}
	paper-button.blue {
		color: white;
		background-color: blue;
	}
	paper-button.red {
		background-color: red;
	}
</style>
<template>
	<div class="checkins">
		<template is="dom-repeat" items="{{callsigns}}" class="checkins">
			<el-checkin
				callsign="{{item}}"
				traffic="{{item.traffic}}"
				is-ncs="{{isActiveAndNcs}}"
				></el-checkin>
		</template>
	</div>

	<el-dialog heading="New Checkin" id="checkin" no-outside>
		<div id="callsignAutoComplete"></div>
		<div style="padding-bottom: 100px"></div>
	</el-dialog>

	<el-dialog heading="New Callsign" id="newcallsign" no-outside enter-pressed="addAndCheckin">
		<paper-input value="{{callsign.callsign}}" label="Callsign"></paper-input>
		<paper-input value="{{callsign.name}}" label="Name" autofocus></paper-input>
		<paper-input value="{{callsign.county}}" label="County"></paper-input>
		<paper-input value="{{callsign.city}}" label="City"></paper-input>
		<div style="text-align: center">
			<paper-button on-tap="addAndCheckin" rasied style="background-color: blue; color: white">Add</paper-button>
		</div>
	</el-dialog>

	<paper-fab icon="add" on-tap="dialog" data-dialog="checkin" hidden="{{!isActiveAndNcs}}"></paper-fab>
	<div class="bottom">
		<span hidden="{{!isNcs}}">
			<paper-button on-tap="netEnd" hidden="{{!isActiveAndNcs}}" class="blue">Close Net</paper-button>
			<paper-button on-tap="netReOpen" hidden="{{isActiveAndNcs}}" class="blue">Re-Open Net</paper-button>
			<span hidden="{{isActiveAndNcs}}">
				<paper-button on-tap="deleteConfirm" hidden="{{deleteHidden}}" class="red">Delete Net</paper-button>
				<paper-button on-tap="netDelete" hidden="{{!deleteHidden}}" class="red">Really Delete</paper-button>
				<paper-button on-tap="deleteConfirm" hidden="{{!deleteHidden}}" class="blue">Cancel</paper-button>
			</span>
		</span>
	</div>
</template>
</dom-module>
<script>
	Polymer({
		is: 'elp-net',
		properties: {
			info: {
				type: Object,
				value: {
					title: 'Net',
					url: '/net'
				}
			},
			callsign: {
				type: Object,
				value: {
					callsign: 'one'
				}
			},
			callsignInput: {
				type: String,
				value: ''
			},
			checkins: {
				type: Array,
				value: []
			},
			deleteHidden: {
				type: Boolean,
				value: false
			},
			isActiveAndNcs: {
				type: Boolean,
				value: false
			},
			isNcs: {
				type: Boolean,
				value: false
			},
			net: {
				type: Object,
			}
		},
		behaviors: [
			Polymer.ELBehavior
		],
		ready: function() {
			if(netId) {
				var net = netId;
				if(net == 'new')
					var ncs = EL.user.cid;
			} else {
				var location = window.location.pathname.split( '/' );
				var net = location[2];
				if(net == '') {
					EL.setPage(['nets']);
					return;
				}
			}
			this.jaxson('nets/retrieve_entry',{
				net: net,
				ncs: ncs,
			});

		},
		autocomplete: function(e,d,o) {
			this.callsignAutoComplete = completely(this.$.callsignAutoComplete);
			this.callsignAutoComplete.input.autofocus = true;
			this.callsignAutoComplete.input.classList.add('callsignAutoComplete');
			this.callsignAutoComplete.input.$.input.bindValue = this.callsignInput;
			this.jaxson("callsigns/list_and_describe", {bypass_token: true});
			this.callsignAutoComplete.onEnter = function() {
				var callsign = this.callsignAutoComplete.getText().toLowerCase();
				this.callsignAutoComplete.hideDropDown();
				var index = -1;
				for(var i = 0; i < this.allcallsigns.length; i++){
					if (this.allcallsigns[i] != null && callsign == this.allcallsigns[i].toLowerCase())
						index = i;
				}
				if(index == -1) {
					this.callsign = {
						callsign: callsign.toUpperCase()
					};
					console.log("this.callsign.callsign",this.callsign.callsign);
					this.dialog('newcallsign');
				} else {
					this.jaxson('nets/new_checkin',{
						net: this.net.id,
						cid: this.allcallsignids[index],
					});
				}
				this.callsignAutoComplete.setText('');
			}.bind(this);
		},
		addAndCheckin: function() {
			this.jaxson('nets/add_checkin', {
				net: this.net.id,
				callsign: this.callsign.callsign,
				name: this.callsign.name,
				county: this.callsign.county,
				city: this.callsign.city,
			});
			this.dialog('checkin');
		},
		dialogCheckin: function() {
			this.dialog('checkinNew');
		},
		deleteConfirm: function() {
			this.deleteHidden = !this.deleteHidden;
		},
		netDelete: function() {
			this.jaxson('nets/delete_net', {
				net: this.net.id
			});
		},
		netEnd: function() {
			this.jaxson('nets/end_net', {
				net: this.net.id
			});
		},
		netReOpen: function() {
			this.jaxson('nets/reopen_net', {
				net: this.net.id
			});
		},
		setupSSE: function(net) {
			if(net.active == 1 && !this.isNcs ) {
				if(!this.sse) {
					this.sse = new EventSource('/jaxson/events/net_listener?net=' + net.id + '&bypass_token=true');
					this.sse.addEventListener('checkin', function(event){
						console.log("event.data",event.data);
						var callsigns = JSON.parse(event.data);
						for(var i = 0; i < callsigns.length; i++) {
							callsigns[i].jobs = JSON.parse(callsigns[i].jobs);
						}
						this.callsigns = callsigns;

					}.bind(this));
					this.sse.addEventListener('final', function(event){
						console.log("event",event);
						var callsigns = JSON.parse(event.data);
						for(var i = 0; i < callsigns.length; i++) {
							callsigns[i].jobs = JSON.parse(callsigns[i].jobs);
						}
						this.callsigns = callsigns;
						this.sse.close();
					}.bind(this));
				}
			}
		},
		_dialog: function(dialog, target) {
			return dialog;
		},
		_jaxson: function(info) {
			switch(info.subject) {
				case 'nets':
					switch(info.action) {
						case 'retrieve_entry':
							if(!info.net.id) {
								EL.setPage(['nets'], true);
								break;
							}
							window.history.replaceState({
								element: 'elp-net',
								title: info.net.dow + "'s EagleNet | Eagle Logger",
								url: '/net/' + info.net.id
							}, info.dow + ' | Eagle Logger', '/net/' + info.net.id);
							document.title = info.net.dow + "'s EagleNet | Eagle Logger";
							if(EL.user && info.net.ncs_id == EL.user.cid) {
								this.autocomplete();
								this.isNcs = true;
							}
						case 'reopen_net':
						case 'end_net':
							if(EL.user && info.net.ncs_id == EL.user.cid && info.net.active == 1) this.isActiveAndNcs = true;
							else this.isActiveAndNcs = false;
							if(info.net.active == 1 && !this.isNcs)
								this.setupSSE(info.net);
						case 'add_checkin':
						case 'new_checkin':
						case 'delete_checkin':
							EL.$.header.innerHTML = "<span>" + info.net.dow + "'s EagleNet - " + info.net.month + ", " + info.net.day + "</span><span>NCS: " + info.net.ncs + "</span><span>Checkins: " + info.net.checkins + "</span><span>Traffic: " + info.net.traffic + "</span>"; 
							var callsigns = info.callsigns;
							for(var i = 0; i < callsigns.length; i++) {
								callsigns[i].jobs = JSON.parse(callsigns[i].jobs)
							}
							this.net = info.net;
							this.callsigns = callsigns;

							break;
						case 'delete_net':
							EL.setPage('nets');
							break;
					}
					break;
				case 'callsigns':
					switch(info.action) {
						case 'list_and_describe':
							this.allcallsigns = this.callsignAutoComplete.options = info.callsigns;
							this.allcallsignids = info.ids;
							break;
					}
					break;

			}
		},
	});
</script>