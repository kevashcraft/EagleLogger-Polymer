<dom-module id="elp-nets">
<style>
	:host {
		display: block;
	}
	paper-fab {
		position: fixed;
		bottom: 25px;
		right: 25px;
		background-color: var(--page-fab-color);
		transition: all .2s ease;
	}
	paper-fab:hover {
		background-color: var(--page-fab-color-hover);
	}

</style>
<template>
	<template is="dom-repeat" items="[[nets]]" as="net">
		<el-net
			on-tap="netOpen"
			net="[[net]]"
		></el-net>
	</template>
	<paper-fab icon="add" on-tap="netStart" hidden="{{_calculateHidden('startnet')}}"></paper-fab>
</template>
</dom-module>
<script>
	Polymer({
		is: 'elp-nets',
		properties: {
			info: {
				type: Object,
				value: {
					title: 'Nets',
					url: '/nets'
				}
			},
		},
		behaviors: [
			Polymer.ELBase,
			Polymer.ELBehavior
		],
		ready: function() {
			this.jaxson('nets/list_all');
		},
		netOpen: function(event) {
			var target = findTarget(event, 'el-net');
			EL.setPage(['net'], target.net.id);
		},
		netStart: function() {
			EL.setPage(['net', 'new']);
		},
		setupSSE: function() {
			if(!this.nets || !this.nets[0]) return;
			this.sse = new EventSource('/jaxson/events/nets_listener?net=' + this.nets[0].id + '&active=' + this.nets[0].active + '&bypass_token=true');
			this.sse.addEventListener('nets', function(event){
				this.nets = JSON.parse(event.data);
			}.bind(this));
		},
		_calculateHidden: function(menuItem) {
			if (!EL.authed) return true;
			switch(menuItem) {
				case 'startnet':
					return !EL.user.ncs;
					break;
			}
		},
		_jaxson: function(info) {
			switch(info.subject) {
				case 'nets':
					switch(info.action) {
						case 'list_all':
							this.nets = info.nets;
							this.setupSSE();
							break;
					}
					break;
			}
		},
	});
</script>