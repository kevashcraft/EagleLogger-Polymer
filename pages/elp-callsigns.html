<dom-module id="elp-callsigns">
<style>
	:host {
		display: block;
	}
	paper-dialog paper-icon-button[icon="close"] {
		position: absolute;
		top: -5px;
		right: 0;
	}
	paper-dialog paper-button {
		display: block;
	}

	paper-fab {
		position: fixed;
		bottom: 25px;
		right: 25px;
	}
</style>
<template>
	<template is="dom-repeat" items="{{callsigns}}">
		<el-callsign
			on-tap="dialog"
			data-dialog="callsignUpdate"
			callsign="{{item}}"
		></el-callsign>
	</template>
	<el-dialog heading="Add Callsign" id="callsignAdd" no-outside enter-pressed="callsignAdd">
		<paper-input label="Callsign" value="{{cs}}" autofocus></paper-input>
		<paper-input label="Name" value="{{callsign.name}}"></paper-input>
		<paper-input label="City" value="{{callsign.city}}"></paper-input>
		<paper-input label="County" value="{{callsign.county}}"></paper-input>
		<template is="dom-repeat" items="{{jobs}}">
			<div>
				<span style="width: 200px">{{item}}</span>
				<paper-icon-button icon="delete" on-tap="jobsRemove" data-index="{{index}}"></paper-icon-button>
			</div>
		</template>
		<div>
			<paper-input label="Job" value="{{job}}" style="display: inline-block"></paper-input>
			<paper-icon-button icon="add" on-tap="jobsAdd"></paper-icon-button>
		</div>
		<paper-button on-tap="callsignAdd" raised>Add</paper-button>
	</el-dialog>

	<el-dialog heading="Update Callsign" id="callsignUpdate" no-outside>
		<paper-input label="Callsign" value="{{cs}}" autofocus></paper-input>
		<paper-input label="Name" value="{{callsign.name}}"></paper-input>
		<paper-input label="City" value="{{callsign.city}}"></paper-input>
		<paper-input label="County" value="{{callsign.county}}"></paper-input>
		<template is="dom-repeat" items="{{jobs}}">
			<div>
				<span style="width: 200px">{{item}}</span>
				<paper-icon-button icon="delete" on-tap="jobsRemove"></paper-icon-button>
				<span hidden="true">{{index}}</span>
			</div>
		</template>
		<div>
			<paper-input label="Job" value="{{job}}" style="display: inline-block"></paper-input>
			<paper-icon-button icon="add" on-tap="jobsAdd"></paper-icon-button>
		</div>
		<paper-button on-tap="callsignUpdate" raised>Update</paper-button>
	</el-dialog>

	<paper-fab icon="add" on-tap="dialog" data-dialog="callsignAdd"></paper-fab>
</template>
</dom-module>
<script>
	Polymer({
		is: 'elp-callsigns',
		properties: {
			info: {
				type: Object,
				value: {
					title: 'Callsigns',
					url: '/callsigns'
				}
			},
			jobs: {
				type: Array,
				value: []
			},			
		},
		observers: [
			'_callsignChanged(cs)'
		],
		behaviors: [
			Polymer.ELBehavior
		],
		ready: function() {
			this.jaxson('callsigns/list_all');
			EL._searchChanged = function() { this._searchChanged() }.bind(this);
		},
		callsignAdd: function() {
			this.dialogClose();
			if(this.job)
				this.jobs.push(this.job);
			this.jaxson('callsigns/add_entry',{
				callsign: this.cs,
				name: this.callsign.name,
				city: this.callsign.city,
				county: this.callsign.county,
				jobs: JSON.stringify(this.jobs)
			});
		},
		callsignUpdate: function() {
			this.dialogClose();
			if(this.job)
				this.jobs.push(this.job);
			this.jaxson('callsigns/update_entry',{
				id: this.callsign.id,
				callsign: this.cs,
				name: this.callsign.name,
				city: this.callsign.city,
				county: this.callsign.county,
				jobs: JSON.stringify(this.jobs)
			});
		},
		jobsAdd: function(event) {
			this.jobs.push(this.job);
			this.job = '';
			this.jobs = JSON.parse(JSON.stringify(this.jobs));
			this.dialog.notifyResize();
		},
		jobsRemove: function(event) {
			var target = findTarget(event, 'paper-icon-button');
			var index = target.nextElementSibling.textContent;
			this.jobs.splice(index, 1);
			this.jobs = JSON.parse(JSON.stringify(this.jobs));
			this.dialog.notifyResize();
		},
		_calculateIcon: function(index,jobs) {
			if(index == jobs.length - 1) return 'add';
			else return 'delete';
		},
		_callsignChanged: function(callsign) {
			if(typeof callsign != 'undefined')
				this.cs = callsign.toUpperCase();
		},
		_dialog: function(dialog, target) {
			switch(dialog) {
				case 'callsignAdd':
					this.$[dialog].dataset.enter = "callsignAdd";
					this.callsign = {};
					this.cs = '';
					this.job = null;
					this.jobs = [];
					this.jobs = JSON.parse(JSON.stringify(this.jobs));
					break;
				case 'callsignUpdate':
					this.callsign = target.callsign;
					this.cs = this.callsign.callsign;
					this.job = null;
					if(this.callsign.jobs != null && this.callsign.jobs.length != 0)
						this.jobs = this.callsign.jobs;
					else
						this.jobs = [];
					this.jobs = JSON.parse(JSON.stringify(this.jobs));
					this.$[dialog].dataset.enter = "callsignUpdate";
					break;
			}
			return dialog;
		},
		_jaxson: function(info) {
			switch(info.subject) {
				case 'callsigns':
					switch(info.action) {
						case 'add_entry':
							this.dialog('callsignAdd')
						case 'list_all':
						case 'update_entry':
							var callsigns = info.callsigns;
							for(var i = 0; i < callsigns.length; i++) {
								callsigns[i].jobs = JSON.parse(callsigns[i].jobs)
							}
							this.callsigns = this.allcallsigns = callsigns;
							break;
					}
					break;

			}
		},
		_searchChanged: function() {
			console.log("el.search",el.search);
		},
	});
</script>